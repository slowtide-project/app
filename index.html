<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Slowtide</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Slowtide">

    <link rel="icon" type="image/png" href="assets/icon.png">
    <link rel="apple-touch-icon" href="assets/icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TJX61DSDD8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-TJX61DSDD8', {
            anonymize_ip: true,
            allow_google_signals: false,
            allow_ad_personalization_signals: false
        });
    </script>

    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

    <div id="app-container">
        <div id="sunset-overlay"></div>
        <div id="header-area">
            <div id="app-title">Slowtide</div>
        </div>

        <div id="settings-modal" class="modal-overlay">
            <div id="timer-display">Not Started</div>
            <button id="pause-btn" class="action-btn pause-btn" onclick="togglePause()">Pause Session</button>

            <div class="setting-row mt-20">
                <span class="setting-label">Update Duration</span>
                <button class="opt-btn time-btn" data-time="15" onclick="changeDuration(15)">15m</button>
                <button class="opt-btn time-btn" data-time="30" onclick="changeDuration(30)">30m</button>
                <button class="opt-btn time-btn" data-time="60" onclick="changeDuration(60)">60m</button>
                <button class="opt-btn time-btn" data-time="90" onclick="changeDuration(90)">90m</button>
                <button class="opt-btn time-btn" data-time="120" onclick="changeDuration(120)">120m</button>
            </div>

            <div class="setting-row">
                <span class="setting-label">Soundscape (Background)</span>
                <button class="opt-btn sound-btn" data-sound="deep" onclick="changeSound('deep')">Deep</button>
                <button class="opt-btn sound-btn" data-sound="rain" onclick="changeSound('rain')">Rain</button>
                <button class="opt-btn sound-btn" data-sound="static" onclick="changeSound('static')">Static</button>
                <button class="opt-btn sound-btn" data-sound="waves" onclick="changeSound('waves')">Waves</button>
                <button class="opt-btn sound-btn" data-sound="off" onclick="changeSound('off')">Silent</button>
            </div>

            <div class="setting-row">
                <span class="setting-label">Interactive Effects</span>
                <button class="opt-btn sfx-btn selected" data-sfx="on" onclick="setSFX('on')">ON</button>
                <button class="opt-btn sfx-btn" data-sfx="off" onclick="setSFX('off')">OFF</button>
            </div>

            <button class="action-btn close-btn" onclick="showAdvancedOptionsFromSettings()">Advanced
                Options...</button>

            <button class="action-btn close-btn" onclick="closeSettings()">Close & Resume</button>
            <a href="https://buymeacoffee.com/gary.rutland" target="_blank" class="action-btn close-btn"
                style="display: block; text-decoration: none;">Buy Developer a Coffee</a>
            <button class="action-btn quit-btn" onclick="showQuitConfirm()">End Session</button>
        </div>

        <div id="confirm-modal" class="modal-overlay">
            <h2>End Session?</h2>
            <p>This will stop the audio and return to the Start Screen.</p>
            <div class="flex-row">
                <button class="action-btn close-btn flex-1 mt-0 mb-0" onclick="closeQuitConfirm()">Cancel</button>
                <button class="action-btn quit-btn flex-1 mt-0" onclick="resetApp()">End
                    Session</button>
            </div>
        </div>

        <div id="advanced-options-modal" class="modal-overlay">
            <h2>Advanced Options</h2>
            <p class="modal-subtitle">Configure engagement settings for your child</p>

            <div class="setting-row">
                <span class="setting-label">Behavior Pattern</span>
                <button class="opt-btn pattern-btn selected" data-pattern="chaos"
                    onclick="changeBehaviorPattern('chaos')">Chaos</button>
                <button class="opt-btn pattern-btn" data-pattern="rhythm"
                    onclick="changeBehaviorPattern('rhythm')">Rhythm</button>
                <button class="opt-btn pattern-btn" data-pattern="mix"
                    onclick="changeBehaviorPattern('mix')">Mix</button>
            </div>

            <div class="setting-row">
                <span class="setting-label">Auto-Switch Mode</span>
                <button class="opt-btn switch-btn selected" data-switch="on"
                    onclick="changeAutoSwitchMode('on')">On</button>
                <button class="opt-btn switch-btn" data-switch="off" onclick="changeAutoSwitchMode('off')">Off</button>
                <button class="opt-btn switch-btn" data-switch="long"
                    onclick="changeAutoSwitchMode('long')">Long</button>
            </div>

            <div class="setting-row">
                <span class="setting-label">Visual Density</span>
                <button class="opt-btn density-btn" data-density="minimal"
                    onclick="changeVisualDensity('minimal')">Minimal</button>
                <button class="opt-btn density-btn selected" data-density="standard"
                    onclick="changeVisualDensity('standard')">Standard</button>
                <button class="opt-btn density-btn" data-density="rich"
                    onclick="changeVisualDensity('rich')">Rich</button>
            </div>

            <div class="setting-row">
                <span class="setting-label">Emergent Events</span>
                <button class="opt-btn emergent-btn selected" data-emergent="off"
                    onclick="changeEmergentEvents('off')">Off</button>
                <button class="opt-btn emergent-btn" data-emergent="rare"
                    onclick="changeEmergentEvents('rare')">Rare</button>
                <button class="opt-btn emergent-btn" data-emergent="common"
                    onclick="changeEmergentEvents('common')">Common</button>
            </div>

            <button class="action-btn close-btn mt-20" onclick="closeAdvancedOptions()">Done</button>
        </div>

        <div id="update-modal" class="modal-overlay">
            <h2>Check for Updates?</h2>
            <p class="warning-text"><strong>Internet Connection Required</strong></p>
            <p>This will reload the app from the server to check for the latest version. Any current settings will be
                reset.</p>
            <div class="flex-row">
                <button class="action-btn close-btn flex-1 mt-0 mb-0"
                    onclick="document.getElementById('update-modal').style.display='none'">Cancel</button>
                <button class="action-btn update-confirm-btn flex-1 mt-0" onclick="performUpdate()">Update Now</button>
            </div>
        </div>

        <div id="instructions-modal" class="modal-overlay">
            <h2>Parent Guide</h2>
            <p><strong>1. The Goal:</strong> A low-stimulation environment to help wind down.</p>
            <p><strong>2. Parent Menu:</strong> Tap the "Slowtide" title 5 times quickly to access settings.</p>
            <p><strong>3. Sunset Timer:</strong> The screen dims and audio fades out automatically.</p>
            <p><strong>4. Tips:</strong> Use "Guided Access" (iOS) or "App Pinning" (Android) to lock your child inside
                the app.</p>
            <button class="action-btn close-btn mt-20"
                onclick="document.getElementById('instructions-modal').style.display='none'">Got it</button>
        </div>

        <div id="admin-overlay">
            <div class="admin-header">
                <span>Admin Mode</span>
                <button class="admin-close-btn" onclick="toggleAdminOverlay()">Ã—</button>
            </div>
            <div class="admin-section">
                <h3>Debug Info</h3>
                <div id="admin-debug-info" class="admin-info">
                    <p>Session: <span id="admin-session-status">No</span></p>
                    <p>View: <span id="admin-current-view">-</span></p>
                    <p>Paused: <span id="admin-paused-status">No</span></p>
                    <p>Audio: <span id="admin-audio-status">-</span></p>
                    <p>Entities: <span id="admin-entities-count">0</span></p>
                </div>
            </div>
            <div class="admin-section">
                <h3>Actions</h3>
                <div class="admin-actions">
                    <button class="admin-btn" onclick="adminForceSunset()">Sunset OFF</button>
                </div>
            </div>
        </div>

        <div id="start-screen">
            <div id="update-btn" onclick="document.getElementById('update-modal').style.display='block'"><svg
                    viewBox="0 0 24 24">
                    <path
                        d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                </svg></div>
            <div id="info-btn" onclick="document.getElementById('instructions-modal').style.display='block'">?</div>
            <h1 class="app-logo">SLOWTIDE</h1>
            <div class="picker-section">
                <p class="picker-label">Duration</p>
                <div class="start-opt-row">
                    <button class="start-btn time-btn" data-time="15" onclick="changeDuration(15)">15m</button>
                    <button class="start-btn time-btn" data-time="30" onclick="changeDuration(30)">30m</button>
                    <button class="start-btn time-btn" data-time="60" onclick="changeDuration(60)">60m</button>
                </div>
                <div class="start-opt-row">
                    <button class="start-btn time-btn" data-time="90" onclick="changeDuration(90)">90m</button>
                    <button class="start-btn time-btn" data-time="120" onclick="changeDuration(120)">120m</button>
                </div>
            </div>
            <div class="picker-section">
                <p class="picker-label">Atmosphere</p>
                <div class="start-opt-row">
                    <button class="start-btn sound-btn" data-sound="deep" onclick="changeSound('deep')">Deep</button>
                    <button class="start-btn sound-btn" data-sound="rain" onclick="changeSound('rain')">Rain</button>
                </div>
                <div class="start-opt-row">
                    <button class="start-btn sound-btn" data-sound="static"
                        onclick="changeSound('static')">Static</button>
                    <button class="start-btn sound-btn" data-sound="waves" onclick="changeSound('waves')">Waves</button>
                    <button class="start-btn sound-btn" data-sound="off" onclick="changeSound('off')">Silent</button>
                </div>
            </div>
            <div class="picker-section">
                <p class="picker-label">Options</p>
                <div class="start-opt-row">
                    <button class="start-btn" onclick="showAdvancedOptions()">Advanced Options</button>
                </div>
            </div>
            <div id="begin-btn">BEGIN SESSION</div>
        </div>

        <div id="nav-bar">
            <div class="nav-btn active" id="btn-particles" onclick="switchView('particles')"
                ontouchstart="switchView('particles')"><svg viewBox="0 0 24 24">
                    <path
                        d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
                </svg></div>
            <div class="nav-btn" id="btn-sorting" onclick="switchView('sorting')" ontouchstart="switchView('sorting')">
                <svg viewBox="0 0 24 24">
                    <path d="M3 3H11V11H3V3ZM13 3H21V11H13V3ZM3 13H11V21H3V13ZM13 13H21V21H13V13Z" />
                </svg>
            </div>
            <div class="nav-btn" id="btn-bubbles" onclick="switchView('bubbles')" ontouchstart="switchView('bubbles')">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M13,7H11V11H7V13H11V17H13V13H17V11H13V7Z" />
                </svg>
            </div>
            <div class="nav-btn" id="btn-liquid" onclick="switchView('liquid')" ontouchstart="switchView('liquid')"><svg
                    viewBox="0 0 24 24">
                    <path
                        d="M12,2c-5.33,4.55-8,8.48-8,11.8c0,4.98,3.8,8.2,8,8.2s8-3.22,8-8.2C20,10.48,17.33,6.55,12,2z M12,20c-3.35,0-6-2.57-6-6.2c0-2.34,1.95-5.44,6-9.14c4.05,3.7,6,6.79,6,9.14C18,17.43,15.35,20,12,20z" />
                </svg></div>
            <div class="nav-btn" id="btn-marbles" onclick="switchView('marbles')" ontouchstart="switchView('marbles')">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-5 10c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm10 0c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm-5 7c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z" />
                </svg>
            </div>
        </div>

        <div id="view-container">
            <canvas id="main-canvas"></canvas>
        </div>
    </div>

    <script type="module" src="js/app.js"></script>
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                    console.log('Service Worker registered:', registration);
                })
                .catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
        }
    </script>
</body>

</html>
