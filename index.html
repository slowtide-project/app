<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Slowtide</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Slowtide">

    <link rel="icon" type="image/png" href="assets/icon.png">
    <link rel="apple-touch-icon" href="assets/icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TJX61DSDD8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-TJX61DSDD8', {
            anonymize_ip: true,
            allow_google_signals: false,
            allow_ad_personalization_signals: false
        });
    </script>

    <link rel="stylesheet" href="css/styles.css?v=2">
</head>

<body>

    <div id="app-container">
        <div id="header-area">
            <div id="app-title">Slowtide</div>
        </div>

        <div id="settings-modal" class="modal-overlay">
            <div id="session-id" class="session-id" style="display: none;"></div>
            <div id="timer-display">Not Started</div>
            <button id="pause-btn" class="action-btn pause-btn" onclick="togglePause()">Pause Session</button>

            <div class="setting-row mt-20">
                <span class="setting-label">Update Duration</span>
                <button class="opt-btn time-btn" data-time="15" onclick="changeDuration(15)">15m</button>
                <button class="opt-btn time-btn" data-time="30" onclick="changeDuration(30)">30m</button>
                <button class="opt-btn time-btn" data-time="60" onclick="changeDuration(60)">60m</button>
                <button class="opt-btn time-btn" data-time="90" onclick="changeDuration(90)">90m</button>
                <button class="opt-btn time-btn" data-time="120" onclick="changeDuration(120)">120m</button>
            </div>

            <div class="setting-row">
                <span class="setting-label">Soundscape (Background)</span>
                <button class="opt-btn sound-btn" data-sound="deep" onclick="changeSound('deep')">Deep</button>
                <button class="opt-btn sound-btn" data-sound="rain" onclick="changeSound('rain')">Rain</button>
                <button class="opt-btn sound-btn" data-sound="static" onclick="changeSound('static')">Static</button>
                <button class="opt-btn sound-btn" data-sound="waves" onclick="changeSound('waves')">Waves</button>
                <button class="opt-btn sound-btn" data-sound="off" onclick="changeSound('off')">Silent</button>
            </div>

            <button class="action-btn close-btn" onclick="closeSettings()">Close & Resume</button>
            <button class="action-btn quit-btn" onclick="showQuitConfirm()">End Session</button>
            <a href="https://buymeacoffee.com/gary.rutland" target="_blank" class="action-btn close-btn"
                style="display: block; text-decoration: none;">Buy Developer a Coffee</a>
        </div>

        <div id="confirm-modal" class="modal-overlay">
            <h2>End Session?</h2>
            <p>This will stop the audio and return to the Start Screen.</p>
            <div class="flex-row">
                <button class="action-btn close-btn flex-1 mt-0 mb-0" onclick="closeQuitConfirm()">Cancel</button>
                <button class="action-btn quit-btn flex-1 mt-0" onclick="resetApp()">End Session</button>
            </div>
        </div>

        <div id="update-modal" class="modal-overlay">
            <h2>Check for Updates?</h2>
            <p class="warning-text"><strong>Internet Connection Required</strong></p>
            <p>This will reload the app from the server to check for the latest version. Any current settings will be
                reset.</p>
            <div class="flex-row">
                <button class="action-btn close-btn flex-1 mt-0 mb-0"
                    onclick="document.getElementById('update-modal').style.display='none'">Cancel</button>
                <button class="action-btn update-confirm-btn flex-1 mt-0" onclick="performUpdate()">Update Now</button>
            </div>
        </div>

        <div id="maths-challenge-modal" class="modal-overlay">
            <h2>Parent Verification</h2>
            <p class="modal-subtitle">Solve this to access settings</p>
            <div class="maths-question" id="maths-question">Loading...</div>
            <div class="maths-answer-grid">
                <button class="maths-btn" onclick="checkMathsAnswer(1)">1</button>
                <button class="maths-btn" onclick="checkMathsAnswer(2)">2</button>
                <button class="maths-btn" onclick="checkMathsAnswer(3)">3</button>
                <button class="maths-btn" onclick="checkMathsAnswer(4)">4</button>
                <button class="maths-btn" onclick="checkMathsAnswer(5)">5</button>
                <button class="maths-btn" onclick="checkMathsAnswer(6)">6</button>
                <button class="maths-btn" onclick="checkMathsAnswer(7)">7</button>
                <button class="maths-btn" onclick="checkMathsAnswer(8)">8</button>
                <button class="maths-btn" onclick="checkMathsAnswer(9)">9</button>
            </div>
            <button class="action-btn close-btn" onclick="closeMathsChallenge()">Cancel</button>
        </div>

        <div id="instructions-modal" class="modal-overlay">
            <h2>Parent Guide</h2>
            <p><strong>1. The Goal:</strong> A low-stimulation environment to help wind down.</p>
            <p><strong>2. Parent Menu:</strong> Tap the "Slowtide" title 5 times quickly, then solve a maths question to access settings.</p>
            <p><strong>3. Session Timer:</strong> The timer counts down to the end of the session.</p>
            <p><strong>4. Tips:</strong> Use "Guided Access" (iOS) or "App Pinning" (Android) to lock your child inside
                the app.</p>
            <button class="action-btn close-btn mt-20"
                onclick="document.getElementById('instructions-modal').style.display='none'">Got it</button>
        </div>

        <div id="admin-overlay">
            <div class="admin-header">
                <span>Admin Mode</span>
                <button class="admin-close-btn" onclick="toggleAdminOverlay()">√ó</button>
            </div>
            <div class="admin-section">
                <h3>Debug Info</h3>
                <div id="admin-debug-info" class="admin-info">
                    <p>Session: <span id="admin-session-status">No</span></p>
                    <p>Mode: <span id="admin-current-mode">-</span></p>
                    <p>View: <span id="admin-current-view">-</span></p>
                    <p>Paused: <span id="admin-paused-status">No</span></p>
                    <p>Audio: <span id="admin-audio-status">-</span></p>
                    <p>Entities: <span id="admin-entities-count">0</span></p>
                </div>
            </div>
            <div class="admin-section">
                <h3>Story Scenes</h3>
                <div class="admin-actions">
                    <button class="admin-btn" onclick="adminSwitchScene()">Switch Scene</button>
                    <p class="admin-hint">Current: <span id="admin-current-scene">Forest</span></p>
                </div>
            </div>
        </div>

        <!-- Legacy start screen (hidden, kept for compatibility) -->
        <div id="start-screen" style="display: none;"></div>

        <div id="app-selection-screen">
            <div id="update-btn" onclick="document.getElementById('update-modal').style.display='block'"><svg
                    viewBox="0 0 24 24">
                    <path
                        d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                </svg></div>
            <div id="info-btn" onclick="document.getElementById('instructions-modal').style.display='block'">?</div>
            <h1 class="app-logo">SLOWTIDE</h1>
            <div class="picker-section">
                <p class="picker-label">Choose Your Experience</p>
                <div class="app-selection-row">
                    <button class="app-selection-btn" id="btn-activities" onclick="selectApp('activities')">
                        <div class="app-icon">üé®</div>
                        <div class="app-title">Activities</div>
                        <div class="app-description">Interactive play and exploration</div>
                    </button>
                    <button class="app-selection-btn" id="btn-story" onclick="selectApp('story')">
                        <div class="app-icon">üå≤</div>
                        <div class="app-title">Story</div>
                        <div class="app-description">Peaceful forest scenes</div>
                    </button>
                </div>
            </div>
        </div>

        <div id="start-screen-activities" style="display: none;">
            <button class="back-btn-top" onclick="backToAppSelection()">‚Üê Back</button>
            <div class="screen-content">
            <h1 class="app-logo">ACTIVITIES</h1>
            <div class="picker-section">
                <p class="picker-label">Duration</p>
                <div class="start-opt-row">
                    <button class="start-btn time-btn" data-time="15" onclick="changeDuration(15)">15m</button>
                    <button class="start-btn time-btn" data-time="30" onclick="changeDuration(30)">30m</button>
                    <button class="start-btn time-btn" data-time="60" onclick="changeDuration(60)">60m</button>
                </div>
                <div class="start-opt-row">
                    <button class="start-btn time-btn" data-time="90" onclick="changeDuration(90)">90m</button>
                    <button class="start-btn time-btn" data-time="120" onclick="changeDuration(120)">120m</button>
                </div>
            </div>
            <div class="picker-section">
                <p class="picker-label">Atmosphere</p>
                <div class="start-opt-row">
                    <button class="start-btn sound-btn" data-sound="deep" onclick="changeSound('deep')">Deep</button>
                    <button class="start-btn sound-btn" data-sound="rain" onclick="changeSound('rain')">Rain</button>
                </div>
                <div class="start-opt-row">
                    <button class="start-btn sound-btn" data-sound="static"
                        onclick="changeSound('static')">Static</button>
                    <button class="start-btn sound-btn" data-sound="waves" onclick="changeSound('waves')">Waves</button>
                    <button class="start-btn sound-btn" data-sound="off" onclick="changeSound('off')">Silent</button>
                </div>
            </div>
            <div class="start-opt-row">
                <div id="begin-activities-btn">BEGIN ACTIVITIES</div>
            </div>
            </div>
        </div>

        <div id="start-screen-story" style="display: none;">
            <button class="back-btn-top" onclick="backToAppSelection()">‚Üê Back</button>
            <div class="screen-content">
            <h1 class="app-logo">STORY</h1>
            <div class="picker-section">
                <p class="picker-label">Duration</p>
                <div class="start-opt-row">
                    <button class="start-btn time-btn" data-time="15" onclick="changeDuration(15)">15m</button>
                    <button class="start-btn time-btn" data-time="30" onclick="changeDuration(30)">30m</button>
                    <button class="start-btn time-btn" data-time="60" onclick="changeDuration(60)">60m</button>
                </div>
                <div class="start-opt-row">
                    <button class="start-btn time-btn" data-time="90" onclick="changeDuration(90)">90m</button>
                    <button class="start-btn time-btn" data-time="120" onclick="changeDuration(120)">120m</button>
                </div>
            </div>
            <div class="start-opt-row">
                <div id="begin-story-btn">BEGIN STORY</div>
            </div>
            </div>
        </div>

        <div id="nav-bar-activities">
            <div class="nav-btn active" id="btn-particles" onclick="switchView('particles')"
                ontouchstart="switchView('particles')"><svg viewBox="0 0 24 24">
                    <path
                        d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
                </svg></div>
            <div class="nav-btn" id="btn-sorting" onclick="switchView('sorting')" ontouchstart="switchView('sorting')">
                <svg viewBox="0 0 24 24">
                    <path d="M3 3H11V11H3V3ZM13 3H21V11H13V3ZM3 13H11V21H3V13ZM13 13H21V21H13V13Z" />
                </svg>
            </div>
            <div class="nav-btn" id="btn-bubbles" onclick="switchView('bubbles')" ontouchstart="switchView('bubbles')">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M13,7H11V11H7V13H11V17H13V13H17V11H13V7Z" />
                </svg>
            </div>
            <div class="nav-btn" id="btn-liquid" onclick="switchView('liquid')" ontouchstart="switchView('liquid')"><svg
                    viewBox="0 0 24 24">
                    <path
                        d="M12,2c-5.33,4.55-8,8.48-8,11.8c0,4.98,3.8,8.2,8,8.2s8-3.22,8-8.2C20,10.48,17.33,6.55,12,2z M12,20c-3.35,0-6-2.57-6-6.2c0-2.34,1.95-5.44,6-9.14c4.05,3.7,6,6.79,6,9.14C18,17.43,15.35,20,12,20z" />
                </svg></div>
            <div class="nav-btn" id="btn-marbles" onclick="switchView('marbles')" ontouchstart="switchView('marbles')">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-5 10c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm10 0c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm-5 7c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z" />
                </svg>
            </div>
        </div>

        <div id="nav-bar-story">
            <div class="nav-btn active" id="btn-forest" onclick="switchView('forest')" ontouchstart="switchView('forest')"><svg viewBox="0 0 24 24">
                    <path d="M17,8C8,10 5.9,16.17 3.82,21.34L5.71,22l1-2.3A4.49,4.49 0 0,0 8,20C19,20 22,3 22,3C21,5 14,5.25 9,6.25S2,11.5 2,13.5C2,15.5 3.75,17.25 3.75,17.25C7,8 17,8 17,8Z" />
                </svg></div>
            <div class="nav-btn" id="btn-beach" onclick="switchView('beach')" ontouchstart="switchView('beach')"><svg viewBox="0 0 24 24">
                    <path d="M17,16C14,16 12,13.5 12,13.5C12,13.5 10,16 7,16C4,16 2,13.5 2,13.5C2,13.5 4,8 7,8C7,8 9,12 12,12C12,12 15,8 17,8C20,8 22,13.5 22,13.5C22,13.5 20,16 17,16Z" />
                </svg></div>
            <div class="nav-btn" id="btn-meadow" onclick="switchView('meadow')" ontouchstart="switchView('meadow')"><svg viewBox="0 0 24 24">
                    <path d="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A1.5,1.5 0 0,0 13.5,19.5C13.5,19.11 13.35,18.76 13.11,18.5C12.88,18.23 12.73,17.88 12.73,17.5A2.27,2.27 0 0,1 15,15.23V15A2.27,2.27 0 0,1 12.73,12.77C12.73,12.39 12.88,12.24 13.11,12C13.35,11.74 13.5,11.39 13.5,11C13.5,10.61 13.35,10.26 13.11,10C12.88,9.76 12.73,9.38 12.73,9A2.27,2.27 0 0,1 15,6.77V6.5A2.27,2.27 0 0,1 12.73,4.23C12.73,3.84 12.88,3.69 13.11,3.43C13.35,3.17 13.5,2.82 13.5,2.5A1.5,1.5 0 0,0 12,1A9,9 0 0,0 3,12Z" />
                </svg></div>
            <div class="nav-btn" id="btn-night" onclick="switchView('night')" ontouchstart="switchView('night')"><svg viewBox="0 0 24 24">
                    <path d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95Z" />
                </svg></div>
            <div class="nav-btn" id="btn-lake" onclick="switchView('lake')" ontouchstart="switchView('lake')"><svg viewBox="0 0 24 24">
                    <path d="M12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22M12,4C7.31,4 3.07,6.69 1.32,11.06C1.28,11.15 1.25,11.24 1.23,11.32C1.22,11.34 1.22,11.36 1.21,11.38C1.19,11.5 1.17,11.61 1.17,11.73C1.17,12.13 1.34,12.5 1.6,12.77C1.79,12.97 2.02,13.11 2.28,13.18C2.5,13.25 2.72,13.27 2.93,13.23C3.14,13.19 3.33,13.09 3.5,12.94C3.5,12.94 3.56,12.88 3.56,12.88C4.08,12.47 4.63,12.03 5.23,11.62C5.66,11.32 6.1,11 6.57,10.72C7.5,10.15 8.5,9.72 9.57,9.45C10.35,9.24 11.16,9.14 12,9.14C12.84,9.14 13.65,9.24 14.43,9.45C15.5,9.72 16.5,10.15 17.43,10.72C17.9,11 18.34,11.32 18.77,11.62C19.37,12.03 19.92,12.47 20.44,12.88C20.44,12.88 20.5,12.94 20.5,12.94C20.67,13.09 20.86,13.19 21.07,13.23C21.28,13.27 21.5,13.25 21.72,13.18C21.98,13.11 22.21,12.97 22.4,12.77C22.66,12.5 22.83,12.13 22.83,11.73C22.83,11.61 22.81,11.5 22.79,11.38C22.78,11.36 22.77,11.34 22.77,11.32C22.75,11.24 22.72,11.15 22.68,11.06C20.93,6.69 16.69,4 12,4Z" />
                </svg></div>
        </div>

        <div id="view-container">
            <canvas id="main-canvas"></canvas>
        </div>
    </div>

    <script type="module" src="js/app.js"></script>
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('Service Worker registered:', registration);
                })
                .catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
        }
    </script>
</body>

</html>
